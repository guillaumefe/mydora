<!DOCTYPE html>
<html lang="en">
<head>
<style>

:root {
  --primary-50: #eff6ff;
  --primary-100: #dbeafe;
  --primary-200: #bfdbfe;
  --primary-500: #3b82f6;
  --primary-600: #2563eb;
  --primary-700: #1d4ed8;
  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-900: #111827;
  --success-50: #ecfdf5;
  --success-500: #10b981;
  --success-600: #059669;
  --warning-50: #fffbeb;
  --warning-500: #f59e0b;
  --warning-600: #d97706;
  --danger-50: #fef2f2;
  --danger-500: #ef4444;
  --danger-600: #dc2626;
  --space-1: 0.25rem;
  --space-2: 0.5rem;
  --space-3: 0.75rem;
  --space-4: 1rem;
  --space-6: 1.5rem;
  --space-8: 2rem;
  --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
  --radius-sm: 0.375rem;
  --radius-md: 0.5rem;
  --radius-lg: 0.75rem;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: system-ui, -apple-system, sans-serif;
  line-height: 1.5;
  background-color: var(--gray-50);
  color: var(--gray-900);
  -webkit-font-smoothing: antialiased;
}

.container {
  width: 100%;
  padding: var(--space-4);
  margin: 0 auto;
}

@media (min-width: 640px) {
  .container {
    padding: var(--space-6);
  }
}

.card {
  background-color: white;
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  margin-bottom: var(--space-4);
  border: 1px solid var(--gray-200);
  box-shadow: var(--shadow-sm);
  transition: box-shadow 0.2s ease;
}

.card:hover {
  box-shadow: var(--shadow-md);
}

.header {
  margin-bottom: var(--space-6);
}

.title {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--gray-900);
  margin-bottom: var(--space-2);
}

.compliance-rate {
  font-size: 1.125rem;
  color: var(--primary-600);
  font-weight: 500;
  margin-bottom: var(--space-4);
}

.import-export-bar {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  background-color: var(--primary-50);
  padding: var(--space-3);
  border-radius: var(--radius-md);
  margin-bottom: var(--space-4);
}

.search-container {
  margin-bottom: var(--space-4);
}

.input {
  width: 100%;
  padding: var(--space-3) var(--space-4);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  font-size: 1rem;
  transition: all 0.2s ease;
}

.input:focus {
  outline: none;
  border-color: var(--primary-500);
  box-shadow: 0 0 0 2px var(--primary-100);
}

.button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-2) var(--space-4);
  border-radius: var(--radius-md);
  font-weight: 500;
  font-size: 0.875rem;
  transition: all 0.2s ease;
  cursor: pointer;
  border: none;
  background-color: var(--primary-600);
  color: white;
  gap: var(--space-2);
}

.button:hover {
  background-color: var(--primary-700);
}

.button.secondary {
  background-color: var(--gray-100);
  color: var(--gray-700);
}

.button.secondary:hover {
  background-color: var(--gray-200);
}

.tabs {
  display: flex;
  overflow-x: auto;
  gap: var(--space-2);
  margin-bottom: var(--space-4);
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  padding-bottom: var(--space-2);
}

.tabs::-webkit-scrollbar {
  display: none;
}

.tab {
  padding: var(--space-2) var(--space-4);
  background-color: var(--gray-100);
  border-radius: var(--radius-md);
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--gray-700);
  white-space: nowrap;
  cursor: pointer;
  transition: all 0.2s ease;
}

.tab.active {
  background-color: var(--primary-600);
  color: white;
}

.add-article-container {
  background-color: white;
  border-radius: var(--radius-lg);
  margin-bottom: var(--space-4);
  overflow: hidden;
  border: 1px solid var(--gray-200);
}

.form-header {
  background-color: var(--primary-600);
  color: white;
  padding: var(--space-4);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 500;
}

.form-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
}

.form-content.visible {
  max-height: 2000px;
  padding: var(--space-4);
}

.form-group {
  margin-bottom: var(--space-4);
}

.form-group label {
  display: block;
  margin-bottom: var(--space-2);
  font-weight: 500;
  color: var(--gray-700);
}

.regulation-item {
  background-color: white;
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  margin-bottom: var(--space-4);
  border: 1px solid var(--gray-200);
}

.regulation-header {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-3);
  margin-bottom: var(--space-4);
  padding-bottom: var(--space-3);
  border-bottom: 1px solid var(--gray-200);
}

.action-item {
  background-color: var(--gray-50);
  border-radius: var(--radius-md);
  padding: var(--space-3);
  margin-bottom: var(--space-3);
}

.action-text {
  color: var(--gray-700);
  margin-bottom: var(--space-2);
}

.progress-container {
  display: flex;
  align-items: center;
  gap: var(--space-3);
  margin: var(--space-2) 0;
}

.progress-bar {
  flex: 1;
  height: 0.5rem;
  background-color: var(--gray-200);
  border-radius: var(--radius-sm);
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background-color: var(--success-500);
  transition: width 0.3s ease;
}

.risk-item {
  background-color: var(--gray-50);
  border-radius: var(--radius-md);
  padding: var(--space-3);
  margin-top: var(--space-3);
  border: 1px solid var(--gray-200);
}

@media (min-width: 768px) {
  .regulation-header {
    flex-wrap: nowrap;
  }
  
  .action-item {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--space-4);
    align-items: center;
  }
  
  .progress-container {
    min-width: 200px;
  }
}

@media (min-width: 1024px) {
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .import-export-bar {
    flex-wrap: nowrap;
  }
}

.badge {
  display: inline-flex;
  align-items: center;
  padding: var(--space-1) var(--space-2);
  border-radius: var(--radius-sm);
  font-size: 0.75rem;
  font-weight: 500;
}

.badge-success {
  background-color: var(--success-50);
  color: var(--success-600);
}

.badge-warning {
  background-color: var(--warning-50);
  color: var(--warning-600);
}

.badge-danger {
  background-color: var(--danger-50);
  color: var(--danger-600);
}

.skeleton {
  background: linear-gradient(
    90deg,
    var(--gray-100) 0%,
    var(--gray-200) 50%,
    var(--gray-100) 100%
  );
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% {
    background-position: 200% 0;
  }
  100% {
    background-position: -200% 0;
  }
}

.save-status {
  position: fixed;
  bottom: var(--space-4);
  right: var(--space-4);
  background-color: var(--success-500);
  color: white;
  padding: var(--space-3) var(--space-4);
  border-radius: var(--radius-md);
  font-weight: 500;
  opacity: 0;
  transform: translateY(1rem);
  transition: all 0.3s ease;
  box-shadow: var(--shadow-lg);
}

.save-status.visible {
  opacity: 1;
  transform: translateY(0);
}

.button-group {
  display: flex;
  gap: var(--space-2);
  margin-top: var(--space-3);
  flex-wrap: wrap;
}

.risks-container {
  margin-top: var(--space-3);
}

.remediation-actions {
  margin-left: var(--space-4);
}

.remediation-actions ul {
  padding-left: var(--space-4);
}

.remediation-actions li {
  margin-bottom: var(--space-2);
}

.action-item, .remediation-item {
  transition: all 0.3s ease-out;
}

.action-item.removing, .remediation-item.removing {
  opacity: 0;
  transform: translateX(-20px);
}

.action-item.adding {
  opacity: 0;
  transform: translateY(-20px);
  animation: slideIn 0.3s ease-out forwards;
}

@keyframes slideIn {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.remediation-list {
  margin: 0;
  padding: 0;
  list-style: none;
}

.remediation-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-2);
  margin-bottom: var(--space-2);
  background-color: var(--gray-50);
  border-radius: var(--radius-md);
  transition: opacity 0.3s ease-out;
}

.remediation-item.removing {
  opacity: 0;
}

.remediation-text {
  flex: 1;
  margin-right: var(--space-2);
}

.remediation-buttons {
  display: flex;
  gap: var(--space-2);
}

.raci-container {
    margin: var(--space-4) 0;
    padding: var(--space-4);
    background-color: var(--gray-50);
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
}

.raci-container h4 {
    margin-bottom: var(--space-3);
    color: var(--gray-700);
}

.raci-grid {
    display: grid;
    gap: var(--space-3);
}

.raci-row {
    display: grid;
    grid-template-columns: 150px 1fr;
    align-items: center;
    gap: var(--space-3);
}

.raci-label {
    font-weight: 500;
    color: var(--gray-700);
}

.raci-input {
    flex: 1;
}

.raci-input input {
    width: 100%;
}

@media (max-width: 640px) {
    .raci-row {
        grid-template-columns: 1fr;
        gap: var(--space-2);
    }
}
.raci-container {
    margin: var(--space-4) 0;
    padding: var(--space-4);
    background-color: var(--gray-50);
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
    box-shadow: var(--shadow-sm);
}

.raci-container h4 {
    margin-bottom: var(--space-3);
    color: var(--gray-700);
    font-size: 1rem;
    font-weight: 600;
}

.raci-grid {
    display: grid;
    gap: var(--space-3);
}

.raci-row {
    display: grid;
    grid-template-columns: 150px 1fr;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) 0;
}

.raci-label {
    font-weight: 500;
    color: var(--gray-700);
    font-size: 0.875rem;
}

.raci-input {
    flex: 1;
}

.raci-input input {
    width: 100%;
    transition: all 0.2s ease;
}

.raci-input input:focus {
    border-color: var(--primary-500);
    box-shadow: 0 0 0 2px var(--primary-100);
}

@media (max-width: 640px) {
    .raci-row {
        grid-template-columns: 1fr;
        gap: var(--space-2);
    }
}

.action-item {
    background-color: var(--gray-50);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-3);
    overflow: hidden;
    transition: all 0.3s ease;
}

.action-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background-color: var(--gray-100);
    border-bottom: 1px solid var(--gray-200);
}

.action-title {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.toggle-button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    padding: var(--space-1);
    color: var(--gray-700);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease;
}

.action-content {
    max-height: 2000px;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding: var(--space-3);
}

.action-item.collapsed .action-content {
    max-height: 0;
    padding: 0;
}

.action-item.collapsed .toggle-button {
    transform: rotate(-90deg);
}

.actions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-3);
}

/* Styles pour les sections principales */
.regulation-item {
    background-color: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    margin-bottom: var(--space-6);
    border: 1px solid var(--gray-200);
    transition: box-shadow 0.2s ease;
}

.regulation-item:hover {
    box-shadow: var(--shadow-md);
}

.regulation-header {
    background-color: var(--gray-50);
    border-top-left-radius: var(--radius-lg);
    border-top-right-radius: var(--radius-lg);
    padding: var(--space-4);
    border-bottom: 2px solid var(--primary-100);
    gap: var(--space-4);
}

.regulation-content {
    padding: var(--space-4);
}

/* Style pour le texte de l'exigence */
.regulation-text {
    font-size: 1.1rem;
    color: var(--gray-800);
    padding: var(--space-4);
    background-color: var(--primary-50);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
    border-left: 4px solid var(--primary-500);
}

.regulation-id {
    color: var(--gray-500);
    margin-bottom: var(--space-4);
    font-size: 0.9rem;
}

/* Style pour la section RACI */
.raci-container {
    background-color: var(--gray-50);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin: var(--space-4) 0;
    border: 1px solid var(--gray-200);
}

.raci-container h4 {
    color: var(--gray-700);
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 2px solid var(--primary-200);
}

/* Style pour les actions */
.actions-container {
    background-color: white;
    border-radius: var(--radius-md);
    padding: var(--space-4);
    margin-top: var(--space-4);
    border: 1px solid var(--gray-200);
}

.actions-container h4 {
    color: var(--gray-700);
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-2);
    border-bottom: 2px solid var(--primary-200);
}

.action-item {
    background-color: var(--gray-50);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-3);
    border: 1px solid var(--gray-200);
    overflow: hidden;
}

.action-header {
    background-color: white;
    padding: var(--space-3);
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--gray-200);
}

.action-content {
    padding: var(--space-3);
}

/* Style pour les risques */
.risk-item {
    background-color: white;
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-3);
    border: 1px solid var(--warning-200);
    border-left: 4px solid var(--warning-500);
}

/* Style pour les remédiations */
.remediation-actions {
    margin-left: var(--space-4);
    margin-top: var(--space-3);
}

.remediation-item {
    background-color: var(--success-50);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-2);
    border: 1px solid var(--success-200);
    border-left: 4px solid var(--success-500);
}

/* Buttons améliorés */
.button {
    font-weight: 500;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
}

.button.secondary {
    border: 1px solid var(--gray-200);
    background-color: white;
}

.button.secondary:hover {
    background-color: var(--gray-50);
    border-color: var(--gray-300);
}

/* Status badges pour les risques */
.risk-level {
    display: inline-flex;
    align-items: center;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    font-weight: 500;
    margin-left: var(--space-2);
}

.risk-level.high {
    background-color: var(--danger-50);
    color: var(--danger-600);
}

.risk-level.medium {
    background-color: var(--warning-50);
    color: var(--warning-600);
}

.risk-level.low {
    background-color: var(--success-50);
    color: var(--success-600);
}

/* Animation pour le collapse */
.action-content {
    transition: all 0.3s ease-in-out;
}

.action-item.collapsed .action-content {
    padding-top: 0;
    padding-bottom: 0;
}

/* Séparateurs visuels */
.section-divider {
    height: 1px;
    background-color: var(--gray-200);
    margin: var(--space-4) 0;
}

/* Input groups */
.action-input-container {
    display: flex;
    gap: var(--space-2);
    margin-top: var(--space-4);
    padding: var(--space-3);
    background-color: var(--gray-50);
    border-radius: var(--radius-md);
    border: 1px dashed var(--gray-300);
}

.action-input-container .input {
    flex: 1;
}

/* Styles pour la boîte de dialogue de confirmation */
.confirm-dialog {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.confirm-dialog.visible {
    opacity: 1;
}

.confirm-dialog-content {
    background: white;
    padding: var(--space-6);
    border-radius: var(--radius-lg);
    max-width: 400px;
    width: 90%;
    box-shadow: var(--shadow-lg);
    transform: translateY(20px);
    transition: transform 0.3s ease;
}

.confirm-dialog.visible .confirm-dialog-content {
    transform: translateY(0);
}

.confirm-dialog h3 {
    color: var(--gray-900);
    font-size: 1.25rem;
    margin-bottom: var(--space-4);
}

.confirm-dialog p {
    color: var(--gray-600);
    margin-bottom: var(--space-4);
}

.confirm-dialog .warning-text {
    color: var(--danger-600);
    font-size: 0.875rem;
}

.confirm-buttons {
    display: flex;
    justify-content: flex-end;
    gap: var(--space-3);
    margin-top: var(--space-6);
}

.button.danger {
    background-color: var(--danger-500);
    color: white;
}

.button.danger:hover {
    background-color: var(--danger-600);
}

/* Animation pour la suppression */
.action-item.removing {
    opacity: 0;
    transform: translateX(-20px);
    transition: all 0.3s ease;
}

/* Styles pour les sections pliables */
.section-container {
    margin: var(--space-4) 0;
    border: 1px solid var(--gray-200);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.section-header {
    background-color: var(--gray-50);
    padding: var(--space-3) var(--space-4);
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
}

.section-header:hover {
    background-color: var(--gray-100);
}

.section-header h4 {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin: 0;
    color: var(--gray-700);
    font-size: 1rem;
    font-weight: 600;
}

.toggle-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    transition: transform 0.2s ease;
    color: var(--gray-600);
}

.section-content {
    padding: var(--space-4);
    background-color: white;
    transition: all 0.3s ease;
}

/* État replié */
.section-container.collapsed .section-content {
    height: 0;
    padding: 0;
    overflow: hidden;
}

.section-container.collapsed .toggle-icon {
    transform: rotate(-90deg);
}

/* Animation pour le collapse */
.section-content {
    transition: height 0.3s ease, padding 0.3s ease;
}

.category-controls {
    display: flex;
    gap: var(--space-4);
    margin-top: var(--space-3);
}

.category-controls label {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 500;
    color: var(--gray-700);
}

.category-controls input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--primary-500);
}


</style>
</head>
<body>
<div class="container">
    <div class="add-article-container">
        <div class="form-header" onclick="toggleForm()">
            <span>Ajouter un nouvel article</span>
            <span id="form-toggle">▼</span>
        </div>
        <div class="form-content" id="articleForm">
            <div class="form-group">
                <label for="articleCategory">Catégorie</label>
                <select id="articleCategory" class="input" onchange="toggleConditionalFields()">
                    <option value="">Sélectionnez une catégorie</option>
                    <option value="Level 1">Level 1</option>
                    <option value="RTS">RTS</option>
                    <option value="ITS">ITS</option>
                </select>
            </div>
            <div class="form-group">
                <label for="articleReference">Référence</label>
                <input type="text" id="articleReference" class="input" placeholder="ex: L1-1, RTS-1, ITS-1">
            </div>
            <div class="form-group">
                <label for="articleText">Texte de l'article</label>
                <textarea id="articleText" class="input" placeholder="Entrez le texte de l'article"></textarea>
            </div>
            <div class="conditional-fields" id="level1Fields">
                <div class="form-group">
                    <label for="rtsLink">RTS associée(s)</label>
                    <input type="text" id="rtsLink" class="input" placeholder="ex: RTS-1, RTS-2">
                </div>
                <div class="form-group">
                    <label for="itsLink">ITS associée(s)</label>
                    <input type="text" id="itsLink" class="input" placeholder="ex: ITS-1, ITS-2">
                </div>
            </div>

<div class="conditional-fields" id="rtsItsFields">
                <div class="form-group">
                    <label for="level1Link">Article Level 1 associé</label>
                    <input type="text" id="level1Link" class="input" placeholder="ex: L1-1">
                </div>
            </div>
            <div class="error-message" id="formError"></div>
            <button class="button" onclick="addNewArticle()">Ajouter l'article</button>
        </div>
    </div>
    <div class="card header">
        <h1 class="title">Suivi de Conformité DORA</h1>
        <div class="compliance-rate">Taux de conformité: 0.0%</div>
        <div class="import-export-bar">
            <button class="button secondary" onclick="exportData()">Exporter</button>
            <button class="button secondary" onclick="document.getElementById('importInput').click()">Importer</button>
            <input type="file" id="importInput" style="display: none" onchange="importData(event)">
            <button class="button secondary" onclick="resetAll()">Reset All</button>
            <button class="button secondary" onclick="exportProject()">Export Projet</button>
        </div>
        <div class="search-container">
            <input type="text" class="input" id="searchInput" placeholder="Rechercher un article...">
        </div>
        <div class="tabs" id="statusTabs">
            <div class="tab active" data-status="all" onclick="handleStatusTabClick(event)">Tous</div>
            <div class="tab" data-status="A faire" onclick="handleStatusTabClick(event)">A faire</div>
            <div class="tab" data-status="En cours" onclick="handleStatusTabClick(event)">En cours</div>
            <div class="tab" data-status="Compliant" onclick="handleStatusTabClick(event)">Compliant</div>
            <div class="tab" data-status="Non Applicable" onclick="handleStatusTabClick(event)">Non Applicable</div>
            <div class="tab" data-status="Documentation" onclick="handleStatusTabClick(event)">Documentation</div>
            <div class="tab" data-status="Exigences with Risks" onclick="handleStatusTabClick(event)">Actions avec Risques</div>
        </div>
        <div class="filters" id="categoryFilters">
            <span class="category-filter active" data-category="all">Tous</span>
            <span class="category-filter" data-category="Level 1">Level 1</span>
            <span class="category-filter" data-category="RTS">RTS</span>
            <span class="category-filter" data-category="ITS">ITS</span>
        </div>
        <div class="toggle-visibility" id="toggleVisibility" style="display: none;">
            <label><input type="checkbox" id="showCompliant" checked onchange="renderRegulations()"> Compliant</label>
            <label><input type="checkbox" id="showNonApplicable" checked onchange="renderRegulations()"> Non Applicable</label>
            <label><input type="checkbox" id="showDocumentation" checked onchange="renderRegulations()"> Documentation</label>
        </div>
        <span class="save-status" id="saveStatus">Modifications sauvegardées</span>
    </div>
    <div id="wallItems"></div>
    <div id="regulationsList"></div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
let regulations = [];
let activeFilter = 'all';
let activeStatus = 'all';

function initializeRegulations() {
    return [];
}

function renderWallItems() {
    const wallItemsContainer = document.getElementById('wallItems');
    wallItemsContainer.innerHTML = '';

    regulations.forEach(reg => {
        reg.actions.forEach(action => {
            const wallItem = document.createElement('div');
            wallItem.classList.add('wall-item');

            wallItem.innerHTML = `
                <h3>${action.text}</h3>
                <button onclick="editActionPrompt('${reg.id}', ${action.id})">Éditer</button>
                <button onclick="confirmDeleteAction('${reg.id}', ${action.id})">Supprimer</button>
                <button onclick="addRiskPrompt('${reg.id}', ${action.id})">Ajouter un Risque</button>
                <div id="risks-${action.id}"></div>
            `;

            renderRisks(reg.id, action.id, wallItem);

            wallItemsContainer.appendChild(wallItem);
        });
    });
}

function toggleForm() {
    const formContent = document.getElementById('articleForm');
    const formToggle = document.getElementById('form-toggle');
    formContent.classList.toggle('visible');
    formToggle.textContent = formContent.classList.contains('visible') ? '▲' : '▼';
}

function addActionPrompt() {
    const actionText = prompt("Entrez la description de l'action :");
    if (actionText) {
        addAction(actionText);
        renderActions();
    }
}

function toggleConditionalFields() {
    const category = document.getElementById('articleCategory').value;
    const level1Fields = document.getElementById('level1Fields');
    const rtsItsFields = document.getElementById('rtsItsFields');
    level1Fields.classList.remove('visible');
    rtsItsFields.classList.remove('visible');
    if (category === 'Level 1') {
        level1Fields.classList.add('visible');
    } else if (category === 'RTS' || category === 'ITS') {
        rtsItsFields.classList.add('visible');
    }
}

function renderLinks(article) {
    if (!article) return '';
    let linksHtml = '';
    if (article.category === 'Level 1') {
        if (Array.isArray(article.rtsLinks) && article.rtsLinks.length > 0) {
            linksHtml += `<div class="regulation-links"><div>RTS associée(s): ${article.rtsLinks.join(', ')}</div></div>`;
        }
        if (Array.isArray(article.itsLinks) && article.itsLinks.length > 0) {
            linksHtml += `<div class="regulation-links"><div>ITS associée(s): ${article.itsLinks.join(', ')}</div></div>`;
        }
    } else if (article.category !== 'Level 1' && article.level1Link) {
        linksHtml += `<div class="regulation-links">Article Level 1 associé: ${article.level1Link}</div>`;
    }
    return linksHtml;
}

function renderActions(reg) {
    if (!reg || !Array.isArray(reg.actions)) return '';

    return reg.actions.map(action => {
        const isCollapsed = action.isCollapsed || false;
        return `
            <div class="action-item ${isCollapsed ? 'collapsed' : ''}" id="action-${action.id}">
                <div class="action-header">
                    <div class="action-title">
                        <button class="toggle-button" onclick="toggleAction('${reg.id}', ${action.id})">
                            ${isCollapsed ? '▸' : '▾'}
                        </button>
                        <span class="action-text">${action.text || ''}</span>
                    </div>
                    <div class="action-buttons">
                        <button class="button secondary" onclick="editAction('${reg.id}', ${action.id})">
                            Éditer
                        </button>
                        <button class="button secondary" onclick="removeAction('${reg.id}', ${action.id})">
                            Supprimer
                        </button>
                        <button class="button secondary" onclick="addRiskPrompt('${reg.id}', ${action.id})">
                            Ajouter un Risque
                        </button>
                    </div>
                </div>
                <div class="action-content">
                    <div class="risks-container">
                        ${renderRisks(reg.id, action.id)}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
function renderActions(reg) {
    if (!reg || !Array.isArray(reg.actions)) return '';

    return reg.actions.map(action => {
        const isCollapsed = action.isCollapsed || false;
        return `
            <div class="action-item ${isCollapsed ? 'collapsed' : ''}" id="action-${action.id}">
                <div class="action-header">
                    <div class="action-title">
                        <button class="toggle-button" onclick="toggleAction('${reg.id}', ${action.id})">
                            ${isCollapsed ? '▸' : '▾'}
                        </button>
                        <span class="action-text">${action.text || ''}</span>
                    </div>
                    <div class="action-buttons">
                        <button class="button secondary" onclick="editAction('${reg.id}', ${action.id})">
                            Éditer
                        </button>
                        <button class="button secondary" onclick="removeAction('${reg.id}', ${action.id})">
                            Supprimer
                        </button>
                        <button class="button secondary" onclick="addRiskPrompt('${reg.id}', ${action.id})">
                            Ajouter un Risque
                        </button>
                    </div>
                </div>
                <div class="action-content">
                    <div class="form-group">
                        <label for="percentage-${action.id}">Pourcentage d'avancement:</label>
                        <input type="number" id="percentage-${action.id}" class="input" min="0" max="100" value="${action.percentage}" onchange="updateActionPercentage('${reg.id}', ${action.id}, this.value)">
                    </div>
                    <div class="action-progress-bar">
                        <div class="action-progress-fill" style="width: ${action.percentage}%; background-color: ${getProgressBarColor(action.percentage)};"></div>
                    </div>
                    <div class="raci-container">
                        <h5>RACI</h5>
                        <div class="raci-group">
                            <label for="action-responsible-${action.id}">Responsable (R):</label>
                            <input type="text" id="action-responsible-${action.id}" class="input" value="${action.raci.responsible}" placeholder="Responsable" onchange="updateActionRACI('${reg.id}', ${action.id}, 'responsible', this.value)">
                        </div>
                        <div class="raci-group">
                            <label for="action-accountable-${action.id}">Autorité (A):</label>
                            <input type="text" id="action-accountable-${action.id}" class="input" value="${action.raci.accountable}" placeholder="Autorité" onchange="updateActionRACI('${reg.id}', ${action.id}, 'accountable', this.value)">
                        </div>
                        <div class="raci-group">
                            <label for="action-consulted-${action.id}">Consultés (C):</label>
                            <input type="text" id="action-consulted-${action.id}" class="input" value="${action.raci.consulted}" placeholder="Consultés" onchange="updateActionRACI('${reg.id}', ${action.id}, 'consulted', this.value)">
                        </div>
                        <div class="raci-group">
                            <label for="action-informed-${action.id}">Informés (I):</label>
                            <input type="text" id="action-informed-${action.id}" class="input" value="${action.raci.informed}" placeholder="Informés" onchange="updateActionRACI('${reg.id}', ${action.id}, 'informed', this.value)">
                        </div>
                    </div>
                    <div class="risks-container">
                        ${renderRisks(reg.id, action.id)}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}


function updateActionPercentage(regulationId, actionId, value) {
    const percentage = Math.min(Math.max(parseInt(value), 0), 100); // Ensure 0 <= percentage <= 100
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action =>
                    action.id === actionId
                        ? { ...action, percentage }
                        : action
                )
            };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function updateActionRACI(regulationId, actionId, raciType, value) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action =>
                    action.id === actionId
                        ? { 
                            ...action, 
                            raci: { 
                                ...action.raci, 
                                [raciType]: value 
                            } 
                          }
                        : action
                )
            };
        }
        return reg;
    });
    autoSave();
}


function toggleAction(regulationId, actionId) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        return {
                            ...action,
                            isCollapsed: !action.isCollapsed
                        };
                    }
                    return action;
                })
            };
        }
        return reg;
    });

    // Mettre à jour visuellement sans re-render complet
    const actionElement = document.getElementById(`action-${actionId}`);
    if (actionElement) {
        actionElement.classList.toggle('collapsed');
        const toggleButton = actionElement.querySelector('.toggle-button');
        const actionContent = actionElement.querySelector('.action-content');
        if (actionElement.classList.contains('collapsed')) {
            toggleButton.textContent = '▸';
            actionContent.style.maxHeight = '0px';
        } else {
            toggleButton.textContent = '▾';
            actionContent.style.maxHeight = actionContent.scrollHeight + 'px';
        }
    }
    
    autoSave();
}

// Ajouter un bouton global pour plier/déplier toutes les tâches
function addGlobalToggleButton() {
    const actionsContainer = document.querySelector('.actions-container h4');
    if (actionsContainer) {
        actionsContainer.innerHTML = `
            <div class="actions-header">
                <span>Actions associées</span>
                <button class="button secondary" onclick="toggleAllActions(this)">
                    Tout plier
                </button>
            </div>
        `;
    }
}

function toggleAllActions(button) {
    const isCollapsing = button.textContent.includes('plier');
    
    regulations = regulations.map(reg => ({
        ...reg,
        actions: reg.actions.map(action => ({
            ...action,
            isCollapsed: isCollapsing
        }))
    }));

    // Mettre à jour le texte du bouton
    button.textContent = isCollapsing ? 'Tout déplier' : 'Tout plier';

    // Mettre à jour l'affichage
    renderRegulations();
    autoSave();
}

function confirmDeleteAction(regulationId, actionId) {
    if (confirm("Êtes-vous sûr de vouloir supprimer cette action ?")) {
        removeAction(regulationId, actionId);
    }
}

function getProgressColor(action) {
    if (!action.risks || action.risks.length === 0) {
        return 'var(--success-color)';
    }
    const maxRisk = Math.max(...action.risks.map(r => r.level));
    if (maxRisk <= 4) return 'var(--success-color)';
    if (maxRisk <= 8) return 'var(--warning-color)';
    return 'var(--danger-color)';
}

function renderProofLinks(reg) {
    if (!reg.proofLinks || reg.proofLinks.length === 0) return '';
    return `
        <div class="proof-links">
            <strong>Liens de matérialité:</strong>
            <ul>
                ${reg.proofLinks.map((link, index) => `
                    <li>
                        <a href="${link}" target="_blank">${link}</a>
                        <button class="button secondary" onclick="deleteProofLink('${reg.id}', ${index})">Supprimer</button>
                    </li>
                `).join('')}
            </ul>
        </div>
    `;
}

function renderJustification(reg) {
    if (reg.status !== 'Non Applicable') return '';
    return `
        <div class="justification-input-container">
            <input type="text" class="input" id="justification-input-${reg.id}" placeholder="Ajouter une justification...">
            <button class="button" onclick="addJustification('${reg.id}')">Ajouter</button>
        </div>
        ${renderJustificationList(reg)}
    `;
}

function renderJustificationList(reg) {
    if (!reg.justifications || reg.justifications.length === 0) return '';
    return `
        <div class="justification-list">
            ${reg.justifications.map((justification, index) => `
                <div class="justification-item">
                    <span>${justification.text}</span>
                    <span>${new Date(justification.timestamp).toLocaleString()}</span>
                    <button class="button secondary" onclick="deleteJustification('${reg.id}', ${index})">Supprimer</button>
                </div>
            `).join('')}
        </div>
    `;
}

function getProgressBarColor(percentage) {
    if (percentage >= 80) return 'var(--success-500)';
    if (percentage >= 50) return 'var(--warning-500)';
    return 'var(--danger-500)';
}


function filterRegulation(reg) {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();

    // Filtrage basé sur la recherche
    if (searchTerm) {
        const inRegText = reg.text.toLowerCase().includes(searchTerm);
        const inRegId = reg.id.toLowerCase().includes(searchTerm);
       
        const inActions = reg.actions.some(action => {
            const inActionText = action.text.toLowerCase().includes(searchTerm);
            const inAssignedTo = action.assignedTo && action.assignedTo.toLowerCase().includes(searchTerm);
            const inResponsible = action.raci && action.raci.responsible && action.raci.responsible.toLowerCase().includes(searchTerm);
            const inRiskDescription = action.risks && action.risks.some(risk => risk.description && risk.description.toLowerCase().includes(searchTerm));
            return inActionText || inAssignedTo || inResponsible || inRiskDescription;
        });
       
        if (!inRegText && !inRegId && !inActions) {
            return false;
        }
    }

    // Filtrage basé sur les filtres de catégorie
    if (activeFilter !== 'all') {
        return reg[activeFilter];
    }

    // Filtrage basé sur les filtres de statut existants
    if (activeStatus === 'A faire') {
        const totalProgress = reg.actions.reduce((sum, action) => sum + (action.percentage || 0), 0);
        if (totalProgress > 0) return false;
    } else if (activeStatus === 'En cours') {
        const totalProgress = reg.actions.reduce((sum, action) => sum + (action.percentage || 0), 0);
        if (totalProgress === 0) return false;
    } else if (activeStatus === 'all') {
        const showCompliant = document.getElementById('showCompliant').checked;
        const showNonApplicable = document.getElementById('showNonApplicable').checked;
        const showDocumentation = document.getElementById('showDocumentation').checked;
        if ((reg.status === 'Compliant' && !showCompliant) ||
            (reg.status === 'Non Applicable' && !showNonApplicable) ||
            (reg.status === 'Documentation' && !showDocumentation)) {
            return false;
        }
    } else if (activeStatus !== 'all' && reg.status !== activeStatus) {
        return false;
    }

    return true;
}



function calculateCompliance(regList) {
    let totalCompliance = 0;
    let totalApplicable = 0;
    regList.forEach(reg => {
        if (reg.status === 'Non Applicable' || reg.status === 'Documentation') return;
        totalApplicable++;
        if (reg.status === 'Compliant') {
            totalCompliance += 100;
        } else {
            if (reg.actions.length > 0) {
                let totalActionProgress = reg.actions.reduce((sum, action) => sum + (action.percentage || 0), 0);
                let averageProgress = totalActionProgress / reg.actions.length;
                totalCompliance += averageProgress;
            }
        }
    });
    return totalApplicable ? (totalCompliance / totalApplicable).toFixed(1) : '0.0';
}



function renderRegulations() {
    const regulationsList = document.getElementById('wallItems');
    const complianceRate = document.querySelector('.compliance-rate');
    regulationsList.innerHTML = '';

    // Filtrer les réglementations en fonction des critères actuels
    let filteredRegs = regulations.filter(filterRegulation);

    // Calculer le taux de conformité basé sur les réglementations filtrées
    let compliancePercentage = calculateCompliance(filteredRegs);
    complianceRate.textContent = `Taux de conformité: ${compliancePercentage}%`;

    if (filteredRegs.length === 0) {
        regulationsList.innerHTML = '<div>Aucune exigence trouvée</div>';
    } else {
        filteredRegs.forEach(reg => {
            regulationsList.innerHTML += `
                <div class="regulation-item" id="regulation-${reg.id}">
                    <div class="regulation-header">
                        <!-- Radios de statut existants -->
                        <label>
                            <input type="radio" 
                                name="status-${reg.id}" 
                                class="checkbox" 
                                value="Compliant" 
                                ${reg.status === 'Compliant' ? 'checked' : ''} 
                                onchange="updateStatus('${reg.id}', 'Compliant')"> Compliant
                        </label>
                        <label>
                            <input type="radio" 
                                name="status-${reg.id}" 
                                class="checkbox" 
                                value="Non Applicable" 
                                ${reg.status === 'Non Applicable' ? 'checked' : ''} 
                                onchange="updateStatus('${reg.id}', 'Non Applicable')"> Non Applicable
                        </label>
                        <label>
                            <input type="radio" 
                                name="status-${reg.id}" 
                                class="checkbox" 
                                value="Documentation" 
                                ${reg.status === 'Documentation' ? 'checked' : ''} 
                                onchange="updateStatus('${reg.id}', 'Documentation')"> Documentation
                        </label>
                        <label>
                            <input type="radio" 
                                name="status-${reg.id}" 
                                class="checkbox" 
                                value="Tous" 
                                ${reg.status === 'all' ? 'checked' : ''} 
                                onchange="updateStatus('${reg.id}', 'Tous')"> Remettre dans Tous
                        </label>
                    </div>
                    <div class="regulation-content">
                        <div class="regulation-text">${reg.text}</div>
                        <div class="regulation-id"><i>${reg.id}</i></div>
                        ${renderLinks(reg)}
                        
                        <!-- Sections RACI et Actions avec toggle -->
                        <div class="section-container ${reg.raciCollapsed ? 'collapsed' : ''}" data-section="raci">
                            <div class="section-header" onclick="toggleSection('${reg.id}', 'raci')">
                                <h4>
                                    <span class="toggle-icon">${reg.raciCollapsed ? '▸' : '▾'}</span>
                                    RACI
                                </h4>
                            </div>
                            <div class="section-content">
                                ${renderRACI(reg)}
                            </div>
                        </div>

                        <div class="section-container ${reg.actionsCollapsed ? 'collapsed' : ''}" data-section="actions">
                            <div class="section-header" onclick="toggleSection('${reg.id}', 'actions')">
                                <h4>
                                    <span class="toggle-icon">${reg.actionsCollapsed ? '▸' : '▾'}</span>
                                    Actions associées
                                </h4>
                            </div>
                            <div class="section-content">
                                <div>${renderActions(reg)}</div>
                                <div class="action-input-container">
                                    <input type="text" class="input" id="action-input-${reg.id}" placeholder="Nouvelle action...">
                                    <button class="button" onclick="addAction('${reg.id}', document.getElementById('action-input-${reg.id}').value)">
                                        Ajouter
                                    </button>
                                </div>
                            </div>
                        </div>

                        ${renderJustification(reg)}
                        ${renderProofLinks(reg)}

                        <div class="action-buttons">
                            <button class="button secondary" onclick="editRegulation('${reg.id}')">Éditer</button>
                            <button class="button secondary" onclick="deleteRegulation('${reg.id}')">Supprimer</button>
                        </div>
                    </div>
                </div>
            `;
        });
    }
}




// Ajouter la fonction toggleSection
function toggleSection(regulationId, sectionType) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            const collapseKey = `${sectionType}Collapsed`;
            return {
                ...reg,
                [collapseKey]: !reg[collapseKey]
            };
        }
        return reg;
    });

    // Mettre à jour visuellement sans re-render complet
    const sectionContainer = document.querySelector(`#regulation-${regulationId} .section-container[data-section="${sectionType}"]`);
    if (sectionContainer) {
        sectionContainer.classList.toggle('collapsed');
        const toggleIcon = sectionContainer.querySelector('.toggle-icon');
        if (toggleIcon) {
            toggleIcon.textContent = sectionContainer.classList.contains('collapsed') ? '▸' : '▾';
        }
    }

    autoSave();
}


function updateStatus(regulationId, status) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            if (status === 'Tous') {
                return { ...reg, status: 'all', justification: '', proofLinks: [], justifications: [] };
            }
            return { ...reg, status: status, justification: status !== 'Non Applicable' ? '' : reg.justification, proofLinks: status !== 'Compliant' ? [] : reg.proofLinks };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function addJustification(regulationId) {
    const input = document.getElementById(`justification-input-${regulationId}`);
    const text = input.value.trim();
    if (!text) return;
    const timestamp = Date.now();
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                justifications: [...(reg.justifications || []), { text, timestamp }]
            };
        }
        return reg;
    });
    input.value = '';
    renderRegulations();
    autoSave();
}

function deleteJustification(regulationId, index) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            const newJustifications = [...reg.justifications];
            newJustifications.splice(index, 1);
            return { ...reg, justifications: newJustifications };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function deleteProofLink(regulationId, index) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            const newProofLinks = [...reg.proofLinks];
            newProofLinks.splice(index, 1);
            return { ...reg, proofLinks: newProofLinks };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function addProof(regulationId, proofLink) {
    if (!proofLink.trim()) return;
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return { ...reg, proofLinks: [...(reg.proofLinks || []), proofLink.trim()] };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
    document.getElementById(`proof-input-${regulationId}`).value = '';
}

function editRegulation(regulationId) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return { ...reg, isEditing: true };
        }
        return reg;
    });
    renderRegulations();
}

function saveRegulationEdit(regulationId) {
    const newText = document.getElementById(`edit-reg-text-${regulationId}`).value;
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return { ...reg, text: newText, isEditing: false };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function cancelRegulationEdit(regulationId) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return { ...reg, isEditing: false };
        }
        return reg;
    });
    renderRegulations();
}

function deleteRegulation(regulationId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer cette exigence ?')) return;
    regulations = regulations.filter(reg => reg.id !== regulationId);
    renderRegulations();
    autoSave();
}

function addAction(regulationId, actionText) {
    if (!actionText.trim()) return;

    const newAction = {
        id: Date.now(),
        text: actionText.trim(),
        percentage: 0,
        isEditing: false,
        isCollapsed: false, // Ajouter cette ligne
        risks: [],
        assignedTo: '',
        responsible: '',
        // RACI fields
        raci: {
            responsible: '',
            accountable: '',
            consulted: '',
            informed: ''
        },
        startDate: '',
        endDate: '',
        newDeadline: ''
    };

    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            const updatedReg = {
                ...reg,
                actions: [...reg.actions, newAction]
            };
            return updatedReg;
        }
        return reg;
    });

    const actionsContainer = document.querySelector(`#regulation-${regulationId} .actions-container div`);
    if (actionsContainer) {
        const actionHtml = `
            <div class="action-item" id="action-${newAction.id}">
                <div class="action-content">
                    <span class="action-text">${newAction.text}</span>
                    <div class="action-buttons">
                        <button class="button secondary" onclick="editAction('${regulationId}', ${newAction.id})">Éditer</button>
                        <button class="button secondary" onclick="removeAction('${regulationId}', ${newAction.id})">Supprimer</button>
                        <button class="button secondary" onclick="addRiskPrompt('${regulationId}', ${newAction.id})">Ajouter un Risque</button>
                    </div>
                </div>
                <div class="risks-container"></div>
            </div>
        `;
        actionsContainer.insertAdjacentHTML('beforeend', actionHtml);
    }

    document.getElementById(`action-input-${regulationId}`).value = '';
    autoSave();
}
function addAction(regulationId, actionText) {
    if (!actionText.trim()) return;

    const newAction = {
        id: Date.now(),
        text: actionText.trim(),
        percentage: 0, // Initialize percentage
        isEditing: false,
        isCollapsed: false,
        risks: [],
        assignedTo: '',
        responsible: '',
        startDate: '',
        endDate: '',
        newDeadline: '',
        // RACI fields
        raci: {
            responsible: '',
            accountable: '',
            consulted: '',
            informed: ''
        }
    };

    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: [...reg.actions, newAction]
            };
        }
        return reg;
    });

    renderRegulations();
    autoSave();
}
function addAction(regulationId, actionText) {
    if (!actionText.trim()) return;

    const newAction = {
        id: Date.now(),
        text: actionText.trim(),
        percentage: 0, // Initialisation du pourcentage
        isEditing: false,
        isCollapsed: false,
        risks: [],
        assignedTo: '',
        responsible: '',
        startDate: '',
        endDate: '',
        newDeadline: '',
        // Champs RACI initialisés
        raci: {
            responsible: '',
            accountable: '',
            consulted: '',
            informed: ''
        }
    };

    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: [...reg.actions, newAction]
            };
        }
        return reg;
    });

    renderRegulations();
    autoSave();
}



function editAction(regulationId, actionId) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action =>
                    action.id === actionId ? { ...action, isEditing: true } : action
                )
            };
        }
        return reg;
    });
    renderRegulations();
}

function saveActionEdit(regulationId, actionId) {
    const editTextElement = document.getElementById(`edit-text-${actionId}`);
    if (!editTextElement) {
        console.error(`L'élément d'édition avec l'ID edit-text-${actionId} est introuvable.`);
        return;
    }

    const newText = editTextElement.value.trim();
    const newPercentage = parseInt(document.getElementById(`edit-percentage-${actionId}`)?.value) || 0;

    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action =>
                    action.id === actionId
                        ? { ...action, text: newText, percentage: newPercentage, isEditing: false }
                        : action
                )
            };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function cancelActionEdit(regulationId, actionId) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action =>
                    action.id === actionId
                        ? { ...action, isEditing: false }
                        : action
                )
            };
        }
        return reg;
    });
    renderRegulations();
}

// Modifier le gestionnaire de suppression d'action
function removeAction(regulationId, actionId) {
    const actionElement = document.getElementById(`action-${actionId}`);
    if (!actionElement) return;

    // Créer la boîte de dialogue de confirmation
    const confirmDialog = document.createElement('div');
    confirmDialog.className = 'confirm-dialog';
    confirmDialog.innerHTML = `
        <div class="confirm-dialog-content">
            <h3>Confirmation de suppression</h3>
            <p>Êtes-vous sûr de vouloir supprimer cette action ?</p>
            <p class="warning-text">Cette action est irréversible.</p>
            <div class="confirm-buttons">
                <button class="button secondary" onclick="cancelDeleteAction('${actionId}')">Annuler</button>
                <button class="button danger" onclick="confirmDeleteAction('${regulationId}', '${actionId}')">Supprimer</button>
            </div>
        </div>
    `;

    // Ajouter la boîte de dialogue au corps du document
    document.body.appendChild(confirmDialog);

    // Ajouter un effet de fade-in
    setTimeout(() => confirmDialog.classList.add('visible'), 10);
}

function cancelDeleteAction(actionId) {
    const confirmDialog = document.querySelector('.confirm-dialog');
    if (confirmDialog) {
        confirmDialog.classList.remove('visible');
        setTimeout(() => confirmDialog.remove(), 300);
    }
}

function confirmDeleteAction(regulationId, actionId) {
    const actionElement = document.getElementById(`action-${actionId}`);
    if (actionElement) {
        actionElement.classList.add('removing');
        setTimeout(() => {
            actionElement.remove();

            regulations = regulations.map(reg => {
                if (reg.id === regulationId) {
                    return {
                        ...reg,
                        actions: reg.actions.filter(action => action.id !== actionId)
                    };
                }
                return reg;
            });

            autoSave();
        }, 300);
    }

    // Fermer la boîte de dialogue
    cancelDeleteAction(actionId);
}

function addRiskPrompt(regulationId, actionId) {
    const description = prompt("Entrez la description du risque :");
    const severity = prompt("Entrez le niveau de gravité (1-5) :");
    const likelihood = prompt("Entrez le niveau de vraisemblance (1-5) :");

    if (description && severity && likelihood) {
        addRisk(regulationId, actionId, description, parseInt(severity), parseInt(likelihood));
    }
}

function addRisk(regulationId, actionId, description, severity, likelihood) {
    actionId = Number(actionId);
    
    const risk = {
        id: Date.now(),
        description: description,
        severity: severity,
        likelihood: likelihood,
        level: severity * likelihood,
        remediationActions: [],
        remediated: false
    };

    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        if (!Array.isArray(action.risks)) {
                            action.risks = [];
                        }
                        return { ...action, risks: [...action.risks, risk] };
                    }
                    return action;
                })
            };
        }
        return reg;
    });

    const risksContainer = document.querySelector(`#action-${actionId} .risks-container`);
    if (risksContainer) {
        const riskHtml = `
            <div class="risk-item" id="risk-${risk.id}">
                <p><strong>Risque:</strong> ${risk.description}</p>
                <p>
                    <strong>Gravité:</strong> ${risk.severity} 
                    <strong>Vraisemblance:</strong> ${risk.likelihood} 
                    <strong>Niveau:</strong> ${risk.level}
                </p>
                <div class="button-group">
                    <button class="button secondary" onclick="addRemediationPrompt('${regulationId}', ${actionId}, ${risk.id})">
                        Ajouter une Remédiation
                    </button>
                    <button class="button secondary" onclick="confirmDeleteRisk('${regulationId}', ${actionId}, ${risk.id})">
                        Supprimer
                    </button>
                </div>
            </div>
        `;
        risksContainer.insertAdjacentHTML('beforeend', riskHtml);
    }

    autoSave();
}

function addRemediation(regulationId, actionId, riskId, remediationText) {
    actionId = Number(actionId);
    riskId = Number(riskId);

    // Trouve d'abord le risque pour accéder à ses données
    let currentRisk;
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        return {
                            ...action,
                            risks: action.risks.map(risk => {
                                if (risk.id === riskId) {
                                    // Stocke la référence au risque pour l'utiliser plus tard
                                    currentRisk = risk;
                                    return {
                                        ...risk,
                                        remediationActions: [...(risk.remediationActions || []), remediationText]
                                    };
                                }
                                return risk;
                            })
                        };
                    }
                    return action;
                })
            };
        }
        return reg;
    });

    const riskElement = document.getElementById(`risk-${riskId}`);
    if (riskElement) {
        const remediationsContainer = riskElement.querySelector('.remediation-actions') || document.createElement('div');
        remediationsContainer.classList.add('remediation-actions');
        
        // Utilise currentRisk pour accéder au nombre actuel de remédiations
        const remediationIndex = currentRisk ? (currentRisk.remediationActions?.length || 0) : 0;
        
        const remediationHtml = `
            <div class="remediation-item" data-index="${remediationIndex - 1}">
                <span class="remediation-text">${remediationText}</span>
                <div class="remediation-buttons">
                    <button class="button secondary" onclick="editRemediationPrompt('${regulationId}', ${actionId}, ${riskId}, ${remediationIndex - 1})">
                        Éditer
                    </button>
                    <button class="button secondary" onclick="confirmDeleteRemediation('${regulationId}', ${actionId}, ${riskId}, ${remediationIndex - 1})">
                        Supprimer
                    </button>
                </div>
            </div>
        `;
        remediationsContainer.insertAdjacentHTML('beforeend', remediationHtml);
        
        if (!riskElement.contains(remediationsContainer)) {
            riskElement.appendChild(remediationsContainer);
        }
    }

    autoSave();
}

function addRemediationPrompt(regulationId, actionId, riskId) {
    const remediationText = prompt("Entrez l'action de remédiation :");

    if (remediationText) {
        addRemediation(regulationId, actionId, riskId, remediationText);
    }
}

function removeRisk(regulationId, actionId, riskId) {
    actionId = Number(actionId);
    riskId = Number(riskId);

    const riskElement = document.getElementById(`risk-${riskId}`);
    if (riskElement) {
        riskElement.classList.add('removing');
        setTimeout(() => {
            riskElement.remove();

            regulations = regulations.map(reg => {
                if (reg.id === regulationId) {
                    return {
                        ...reg,
                        actions: reg.actions.map(action => {
                            if (action.id === actionId) {
                                return {
                                    ...action,
                                    risks: action.risks.filter(risk => risk.id !== riskId)
                                };
                            }
                            return action;
                        })
                    };
                }
                return reg;
            });

            autoSave();
        }, 300);
    }
}

function editRisk(regulationId, actionId, riskId) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        return {
                            ...action,
                            risks: action.risks.map(risk =>
                                risk.id === riskId
                                    ? { ...risk, isEditing: true }
                                    : risk
                            )
                        };
                    }
                    return action;
                })
            };
        }
        return reg;
    });
    renderRegulations();
}

function saveRiskEdit(regulationId, actionId, riskId) {
    const severity = parseInt(document.getElementById(`edit-severity-${riskId}`).value);
    const likelihood = parseInt(document.getElementById(`edit-likelihood-${riskId}`).value);
    const description = document.getElementById(`edit-description-${riskId}`).value.trim();
    if (isNaN(severity) || isNaN(likelihood) || severity < 1 || severity >5 || likelihood < 1 || likelihood > 5 || !description) {
        alert("Entrées invalides. Veuillez vérifier vos entrées.");
        return;
    }
    const riskLevel = severity * likelihood;
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        return {
                            ...action,
                            risks: action.risks.map(risk =>
                                risk.id === riskId
                                    ? { ...risk, severity, likelihood, level: riskLevel, description, isEditing: false }
                                    : risk
                            )
                        };
                    }
                    return action;
                })
            };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function cancelRiskEdit(regulationId, actionId, riskId) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        return {
                            ...action,
                            risks: action.risks.map(risk =>
                                risk.id === riskId
                                    ? { ...risk, isEditing: false }
                                    : risk
                            )
                        };
                    }
                    return action;
                })
            };
        }
        return reg;
    });
    renderRegulations();
}

function deleteRisk(regulationId, actionId, riskId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce risque ?')) return;
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        return {
                            ...action,
                            risks: action.risks.filter(risk => risk.id !== riskId)
                        };
                    }
                    return action;
                })
            };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function autoSave() {
    localStorage.setItem('doraCompliance', JSON.stringify(regulations));
    const saveStatus = document.getElementById('saveStatus');
    saveStatus.classList.add('visible');
    setTimeout(() => {
        saveStatus.classList.remove('visible');
    }, 2000);
}

function autoLoad() {
    const savedState = localStorage.getItem('doraCompliance');
    if (savedState) {
        regulations = JSON.parse(savedState);
        // Initialiser les champs de catégorie pour chaque régulation si non définis
        regulations.forEach(reg => {
            reg.isCompliant = reg.isCompliant || false;
            reg.isApplicable = reg.isApplicable !== undefined ? reg.isApplicable : true; // Par défaut, applicable
            reg.isDocumentation = reg.isDocumentation || false;
            
            // Initialiser raci pour chaque action si non défini
            if (Array.isArray(reg.actions)) {
                reg.actions.forEach(action => {
                    if (!action.raci) {
                        action.raci = {
                            responsible: '',
                            accountable: '',
                            consulted: '',
                            informed: ''
                        };
                    }
                });
            }
        });
    } else {
        regulations = initializeRegulations();
    }
}




function exportData() {
    const dataStr = JSON.stringify(regulations, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    const exportFileDefaultName = 'dora-compliance.json';
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

function exportProject() {
    const wb = XLSX.utils.book_new();
    const wsData = [];

    wsData.push(['Category', 'Reference', 'Action', 'Assigné à', 'Responsable', 'Date de début', 'Date de fin', 'Nouvelle Deadline', 'Progression', 'Existence de risque', 'Existence de remédiation']);

    regulations.forEach(reg => {
        reg.actions.forEach(action => {
            const hasUnremediatedRisk = action.risks && action.risks.some(risk => !risk.remediated);
            const hasRemediation = action.risks && action.risks.some(risk => risk.remediationActions && risk.remediationActions.length > 0);

            wsData.push([
                reg.category,
                reg.id,
                action.text,
                action.assignedTo || '',
                action.responsible || '',
                action.startDate || '',
                action.endDate || '',
                action.newDeadline || '',
                action.percentage || 0,
                hasUnremediatedRisk ? 'x' : '',
                hasRemediation ? 'x' : ''
            ]);
        });
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, 'Projet');
    XLSX.writeFile(wb, 'projet.xlsx');
}
function exportProject() {
    const wb = XLSX.utils.book_new();
    const wsData = [];

    // Mettre à jour les en-têtes pour inclure RACI
    wsData.push([
        'Category', 
        'Reference', 
        'Responsible (R)', // RACI de l'exigence
        'Accountable (A)',
        'Consulted (C)',
        'Informed (I)',
        'Action', 
        'Assigné à', 
        'Responsable', 
        'Date de début', 
        'Date de fin', 
        'Nouvelle Deadline', 
        'Progression', 
        'Existence de risque', 
        'Existence de remédiation'
    ]);

    regulations.forEach(reg => {
        // Si pas d'actions, exporter quand même l'exigence avec ses informations RACI
        if (!reg.actions || reg.actions.length === 0) {
            wsData.push([
                reg.category,
                reg.id,
                reg.responsible || '',
                reg.accountable || '',
                reg.consulted || '',
                reg.informed || '',
                '', // Action vide
                '', // Assigné à
                '', // Responsable
                '', // Date début
                '', // Date fin
                '', // Deadline
                '', // Progression
                '', // Risque
                ''  // Remédiation
            ]);
        } else {
            reg.actions.forEach(action => {
                const hasUnremediatedRisk = action.risks && action.risks.some(risk => !risk.remediated);
                const hasRemediation = action.risks && action.risks.some(risk => risk.remediationActions && risk.remediationActions.length > 0);

                wsData.push([
                    reg.category,
                    reg.id,
                    reg.responsible || '',  // RACI de l'exigence
                    reg.accountable || '',
                    reg.consulted || '',
                    reg.informed || '',
                    action.text,
                    action.assignedTo || '',
                    action.responsible || '',
                    action.startDate || '',
                    action.endDate || '',
                    action.newDeadline || '',
                    action.percentage || 0,
                    hasUnremediatedRisk ? 'x' : '',
                    hasRemediation ? 'x' : ''
                ]);
            });
        }
    });

    // Style pour le header
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    
    // Définir la largeur des colonnes
    const colWidths = [
        {wch: 10},  // Category
        {wch: 12},  // Reference
        {wch: 30},  // Responsible (R)
        {wch: 30},  // Accountable (A)
        {wch: 30},  // Consulted (C)
        {wch: 30},  // Informed (I)
        {wch: 50},  // Action
        {wch: 15},  // Assigné à
        {wch: 15},  // Responsable
        {wch: 12},  // Date début
        {wch: 12},  // Date fin
        {wch: 12},  // Nouvelle Deadline
        {wch: 10},  // Progression
        {wch: 10},  // Existence risque
        {wch: 10}   // Existence remédiation
    ];

    ws['!cols'] = colWidths;

    // Style pour le header (première ligne)
    for (let i = 0; i < 15; i++) {
        const cellRef = XLSX.utils.encode_cell({r: 0, c: i});
        if (!ws[cellRef]) ws[cellRef] = {};
        ws[cellRef].s = {
            font: { bold: true },
            fill: { fgColor: { rgb: "CCCCCC" } },
            alignment: { vertical: 'center', horizontal: 'center' }
        };
    }

    XLSX.utils.book_append_sheet(wb, ws, 'Projet');
    XLSX.writeFile(wb, 'projet.xlsx');
}
function exportProject() {
    const wb = XLSX.utils.book_new();
    const wsData = [];

    // Updated headers to include RACI and Percentage
    wsData.push([
        'Category', 
        'Reference', 
        'Responsible (R)', 
        'Accountable (A)',
        'Consulted (C)',
        'Informed (I)',
        'Action', 
        'Assigné à', 
        'Responsable', 
        'Date de début', 
        'Date de fin', 
        'Nouvelle Deadline', 
        'Progression (%)', // Added Percentage
        'Existence de risque', 
        'Existence de remédiation'
    ]);

    regulations.forEach(reg => {
        if (!reg.actions || reg.actions.length === 0) {
            wsData.push([
                reg.category,
                reg.id,
                reg.responsible || '',
                reg.accountable || '',
                reg.consulted || '',
                reg.informed || '',
                '', // Action
                '', // Assigné à
                '', // Responsable
                '', // Date début
                '', // Date fin
                '', // Deadline
                '', // Progression
                '', // Risque
                ''  // Remédiation
            ]);
        } else {
            reg.actions.forEach(action => {
                const hasUnremediatedRisk = action.risks && action.risks.some(risk => !risk.remediated);
                const hasRemediation = action.risks && action.risks.some(risk => risk.remediationActions && risk.remediationActions.length > 0);

                wsData.push([
                    reg.category,
                    reg.id,
                    reg.responsible || '',  // RACI de l'exigence
                    reg.accountable || '',
                    reg.consulted || '',
                    reg.informed || '',
                    action.text,
                    action.assignedTo || '',
                    action.responsible || '',
                    action.startDate || '',
                    action.endDate || '',
                    action.newDeadline || '',
                    action.percentage || 0, // Percentage
                    hasUnremediatedRisk ? 'x' : '',
                    hasRemediation ? 'x' : ''
                ]);
            });
        }
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Define column widths
    const colWidths = [
        {wch: 10},  // Category
        {wch: 12},  // Reference
        {wch: 20},  // Responsible (R)
        {wch: 20},  // Accountable (A)
        {wch: 20},  // Consulted (C)
        {wch: 20},  // Informed (I)
        {wch: 30},  // Action
        {wch: 15},  // Assigné à
        {wch: 15},  // Responsable
        {wch: 12},  // Date début
        {wch: 12},  // Date fin
        {wch: 15},  // Nouvelle Deadline
        {wch: 15},  // Progression (%)
        {wch: 10},  // Existence risque
        {wch: 10}   // Existence remédiation
    ];

    ws['!cols'] = colWidths;

    // Style for the header row
    for (let i = 0; i < wsData[0].length; i++) {
        const cellRef = XLSX.utils.encode_cell({r: 0, c: i});
        if (!ws[cellRef]) ws[cellRef] = {};
        ws[cellRef].s = {
            font: { bold: true },
            fill: { fgColor: { rgb: "CCCCCC" } },
            alignment: { vertical: 'center', horizontal: 'center' }
        };
    }

    XLSX.utils.book_append_sheet(wb, ws, 'Projet');
    XLSX.writeFile(wb, 'projet.xlsx');
}


function markRiskAsRemediated(regulationId, actionId, riskId) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        return {
                            ...action,
                            risks: action.risks.map(risk => {
                                if (risk.id === riskId) {
                                    return {
                                        ...risk,
                                        remediated: true
                                    };
                                }
                                return risk;
                            })
                        };
                    }
                    return action;
                })
            };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}

function renderRisks(regulationId, actionId) {
    if (!regulationId || actionId === undefined) {
        console.error('IDs manquants ou invalides:', { regulationId, actionId });
        return '';
    }

    actionId = Number(actionId);

    const regulation = regulations.find(reg => reg.id === regulationId);
    if (!regulation) return '';

    const action = regulation.actions.find(act => act.id === actionId);
    if (!action || !Array.isArray(action.risks)) return '';

    return action.risks.map(risk => `
        <div class="risk-item" id="risk-${risk.id}">
            <div class="risk-content">
                <p><strong>Risque:</strong> ${risk.description}</p>
                <p>
                    <strong>Gravité:</strong> ${risk.severity} 
                    <strong>Vraisemblance:</strong> ${risk.likelihood} 
                    <strong>Niveau:</strong> ${risk.level}
                </p>
                ${renderRemediations(risk, regulationId, actionId)}
                <div class="button-group">
                    <button class="button secondary" onclick="addRemediationPrompt('${regulationId}', ${actionId}, ${risk.id})">
                        Ajouter une Remédiation
                    </button>
                    <button class="button secondary" onclick="confirmDeleteRisk('${regulationId}', ${actionId}, ${risk.id})">
                        Supprimer
                    </button>
                    ${!risk.remediated ? `
                        <button class="button secondary" onclick="markRiskAsRemediated('${regulationId}', ${actionId}, ${risk.id})">
                            Marquer comme remédié
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `).join('');
}


function renderRemediations(risk, regulationId, actionId) {
    if (!risk || !Array.isArray(risk.remediationActions) || risk.remediationActions.length === 0) {
        return '';
    }

    return `
        <div class="remediation-actions">
            <strong>Actions de Remédiation:</strong>
            <ul class="remediation-list">
                ${risk.remediationActions.map((remediation, index) => `
                    <li class="remediation-item" data-index="${index}">
                        <span class="remediation-text">${remediation || ''}</span>
                        <div class="remediation-buttons">
                            <button class="button secondary" 
                                onclick="editRemediationPrompt('${regulationId}', ${actionId}, ${risk.id}, ${index})">
                                Éditer
                            </button>
                            <button class="button secondary" 
                                onclick="confirmDeleteRemediation('${regulationId}', ${actionId}, ${risk.id}, ${index})">
                                Supprimer
                            </button>
                        </div>
                    </li>
                `).join('')}
            </ul>
        </div>
    `;
}


function confirmDeleteRemediation(regulationId, actionId, riskId, remediationIndex) {
    if (confirm("Êtes-vous sûr de vouloir supprimer cette action de remédiation ?")) {
        removeRemediationAction(regulationId, actionId, riskId, remediationIndex);
    }
}

function removeRemediationAction(regulationId, actionId, riskId, remediationIndex) {
    actionId = Number(actionId);
    riskId = Number(riskId);
    remediationIndex = Number(remediationIndex);

    // Mettre à jour l'état avant l'animation
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                actions: reg.actions.map(action => {
                    if (action.id === actionId) {
                        return {
                            ...action,
                            risks: action.risks.map(risk => {
                                if (risk.id === riskId && Array.isArray(risk.remediationActions)) {
                                    const updatedRemediations = [...risk.remediationActions];
                                    updatedRemediations.splice(remediationIndex, 1);
                                    return {
                                        ...risk,
                                        remediationActions: updatedRemediations
                                    };
                                }
                                return risk;
                            })
                        };
                    }
                    return action;
                })
            };
        }
        return reg;
    });

    // Sauvegarder immédiatement
    autoSave();

    // Mettre à jour l'affichage
    renderRegulations();
}


function editRemediationPrompt(regulationId, actionId, riskId, remediationIndex) {
    const regulation = regulations.find(reg => reg.id === regulationId);
    if (!regulation) return;

    const action = regulation.actions.find(act => act.id === Number(actionId));
    if (!action) return;

    const risk = action.risks.find(r => r.id === Number(riskId));
    if (!risk || !risk.remediationActions) return;

    const currentRemediationText = risk.remediationActions[remediationIndex];
    const newRemediationText = prompt("Modifiez l'intitulé de la remédiation :", currentRemediationText);

    if (newRemediationText !== null && newRemediationText.trim() !== "") {
        regulations = regulations.map(reg => {
            if (reg.id === regulationId) {
                return {
                    ...reg,
                    actions: reg.actions.map(action => {
                        if (action.id === Number(actionId)) {
                            return {
                                ...action,
                                risks: action.risks.map(risk => {
                                    if (risk.id === Number(riskId)) {
                                        const updatedRemediationActions = [...risk.remediationActions];
                                        updatedRemediationActions[remediationIndex] = newRemediationText.trim();
                                        return {
                                            ...risk,
                                            remediationActions: updatedRemediationActions
                                        };
                                    }
                                    return risk;
                                })
                            };
                        }
                        return action;
                    })
                };
            }
            return reg;
        });

        const remediationTextElement = document.querySelector(`#risk-${riskId} .remediation-item[data-index="${remediationIndex}"] .remediation-text`);
        if (remediationTextElement) {
            remediationTextElement.textContent = newRemediationText.trim();
        }

        autoSave();
    }
}

function confirmDeleteRisk(regulationId, actionId, riskId) {
    if (confirm("Êtes-vous sûr de vouloir supprimer ce risque ?")) {
        removeRisk(regulationId, actionId, riskId);
    }
}

function importData(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            regulations = importedData;
            autoSave();
            renderRegulations();
        } catch (error) {
            alert('Erreur lors de l\'importation du fichier. Assurez-vous que le format est correct.');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function handleSearchInput(event) {
    renderRegulations();
}

function handleCategoryFilter(event) {
    if (event.target.classList.contains('category-filter')) {
        document.querySelectorAll('.category-filter').forEach(filter => filter.classList.remove('active'));
        event.target.classList.add('active');
        activeFilter = event.target.dataset.category;
        renderRegulations();
    }
}

function handleStatusTabClick(event) {
    if (event.target.classList.contains('tab')) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        activeStatus = event.target.dataset.status;
        renderRegulations();
    }
}

function resetArticleForm() {
    document.getElementById('articleCategory').value = '';
    document.getElementById('articleReference').value = '';
    document.getElementById('articleText').value = '';
    document.getElementById('rtsLink').value = '';
    document.getElementById('itsLink').value = '';
    document.getElementById('level1Link').value = '';
    document.getElementById('formError').textContent = '';
    toggleConditionalFields();
}

function resetAll() {
    const confirmReset = confirm('⚠️ ATTENTION : Vous êtes sur le point de réinitialiser TOUTE l\'application et supprimer TOUTES les données. Cette action est irréversible. Voulez-vous vraiment continuer ?');
    if (confirmReset) {
        regulations = initializeRegulations();
        autoSave();
        resetArticleForm();
        renderRegulations();
    }
}

function addNewArticle() {
    const category = document.getElementById('articleCategory').value;
    const reference = document.getElementById('articleReference').value;
    const text = document.getElementById('articleText').value;
    const parsedRequirements = parseRequirementsFromText(text);
    parsedRequirements.forEach(req => {
        const articleId = `${reference}-${req.id}`;
        const article = {
            id: articleId,
            category: category,
            text: req.originalText,
            fullPath: req.id,
            parentChain: req.parentChain,
            rtsLinks: [],
            itsLinks: [],
            level1Link: '',
            actions: [],
            status: 'all',
            justification: '',
            proofLinks: [],
            justifications: [],
            // Nouveaux champs RACI
            responsible: '',
            accountable: '',
            consulted: '',
            informed: '',
            raciCollapsed: false,
            actionsCollapsed: false
        };
        if (category === 'Level 1') {
            article.rtsLinks = document.getElementById('rtsLink').value.split(',').map(s => s.trim()).filter(Boolean);
            article.itsLinks = document.getElementById('itsLink').value.split(',').map(s => s.trim()).filter(Boolean);
        } else if (category === 'RTS' || category === 'ITS') {
            article.level1Link = document.getElementById('level1Link').value.trim();
        }
        const existingIndex = regulations.findIndex(reg => reg.id === articleId);
        if (existingIndex !== -1) {
            regulations[existingIndex] = article;
        } else {
            regulations.push(article);
        }
    });
    renderRegulations();
    autoSave();
    resetArticleForm();
}

function parseRequirementsFromText(text) {
    const lines = text.split(/\r?\n/);
    const requirements = [];
    let parentChain = [];
    lines.forEach((line, index) => {
        const content = line.trim();
        if (!content) return;
        const indentation = line.search(/\S|$/);
        const level = Math.floor(indentation / 2);
        parentChain = parentChain.slice(0, level);
        parentChain[level] = content;
        const nextLine = lines[index + 1];
        const nextIndentation = nextLine ? nextLine.search(/\S|$/) : -1;
        const nextLevel = Math.floor(nextIndentation / 2);
        const isLeaf = index === lines.length - 1 || nextLevel <= level;
        if (isLeaf) {
            const fullPath = parentChain.slice(0, level + 1).join('.');
            const requirement = {
                id: fullPath,
                originalText: content,
                level: level,
                parentChain: parentChain.slice(0, level)
            };
            requirements.push(requirement);
        }
    });
    return requirements;
}

function renderRACI(reg) {
    return `
        <div class="raci-container">
            <h4>RACI</h4>
            <div class="raci-grid">
                <div class="raci-row">
                    <div class="raci-label">Responsables (R):</div>
                    <div class="raci-input">
                        <input type="text" 
                            class="input" 
                            id="responsible-${reg.id}" 
                            value="${reg.responsible || ''}" 
                            placeholder="Noms des responsables (séparés par des virgules)"
                            onchange="updateRACI('${reg.id}', 'responsible', this.value)">
                    </div>
                </div>
                <div class="raci-row">
                    <div class="raci-label">Autorité (A):</div>
                    <div class="raci-input">
                        <input type="text" 
                            class="input" 
                            id="accountable-${reg.id}" 
                            value="${reg.accountable || ''}" 
                            placeholder="Nom de la personne ayant autorité"
                            onchange="updateRACI('${reg.id}', 'accountable', this.value)">
                    </div>
                </div>
                <div class="raci-row">
                    <div class="raci-label">Consultés (C):</div>
                    <div class="raci-input">
                        <input type="text" 
                            class="input" 
                            id="consulted-${reg.id}" 
                            value="${reg.consulted || ''}" 
                            placeholder="Noms des personnes consultées (séparés par des virgules)"
                            onchange="updateRACI('${reg.id}', 'consulted', this.value)">
                    </div>
                </div>
                <div class="raci-row">
                    <div class="raci-label">Informés (I):</div>
                    <div class="raci-input">
                        <input type="text" 
                            class="input" 
                            id="informed-${reg.id}" 
                            value="${reg.informed || ''}" 
                            placeholder="Noms des personnes informées (séparés par des virgules)"
                            onchange="updateRACI('${reg.id}', 'informed', this.value)">
                    </div>
                </div>
            </div>
        </div>
    `;
}

function updateRACI(regulationId, raciType, value) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                [raciType]: value
            };
        }
        return reg;
    });
    autoSave();
}

document.addEventListener('DOMContentLoaded', () => {
    autoLoad();
    initializeWall();
    document.getElementById('searchInput').addEventListener('input', handleSearchInput);
    document.getElementById('categoryFilters').addEventListener('click', handleCategoryFilter);
    document.getElementById('statusTabs').addEventListener('click', handleStatusTabClick);
    renderRegulations();
});

function getRiskLevelClass(level) {
    if (level >= 15) return 'high';
    if (level >= 8) return 'medium';
    return 'low';
}

function updateCategory(regulationId, selectedCategory) {
    regulations = regulations.map(reg => {
        if (reg.id === regulationId) {
            return {
                ...reg,
                isCompliant: selectedCategory === 'Compliant',
                isApplicable: selectedCategory === 'Applicable',
                isDocumentation: selectedCategory === 'Documentation'
            };
        }
        return reg;
    });
    renderRegulations();
    autoSave();
}




function initializeWall() {
    renderWallItems();
}
</script>
</body>
</html>
